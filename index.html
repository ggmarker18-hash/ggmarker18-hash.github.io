<!--
Name: Leah Price
Date: 2025-10-07
Description: Browser-based chat client (WebSocket) for the chatroom.
             Simple password-protected login (checked by server).
             Usage: edit WS_URL if your server runs elsewhere.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chatroom (Password Protected)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; display:flex; height:100vh; }
    .sidebar { width:260px; background:#f4f4f6; padding:12px; box-shadow:2px 0 6px rgba(0,0,0,0.06); }
    .main { flex:1; display:flex; flex-direction:column; }
    .messages { flex:1; padding:12px; overflow:auto; background: #ffffff; }
    .inputbar { display:flex; padding:12px; gap:8px; border-top:1px solid #eee; background:#fafafa; }
    input[type="text"] { flex:1; padding:10px; border-radius:6px; border:1px solid #ddd; }
    button { padding:10px 14px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .msg { margin-bottom:8px; }
    .meta { color:#666; font-size:12px; margin-bottom:4px; }
    .private { background: #fffbe6; padding:6px; border-radius:6px; }
    .system { color:#999; font-style:italic; }
    .login-modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); }
    .login { background:white; padding:20px; border-radius:8px; width:320px; box-shadow:0 6px 30px rgba(0,0,0,0.2); }
    .small { font-size:13px; color:#666; margin-top:8px; }
    .users-list { font-size:14px; margin-top:8px; white-space:pre-wrap; }
  </style>
</head>
<body>

  <div class="sidebar">
    <h3>Chatroom</h3>
    <div><strong>Commands:</strong></div>
    <ul>
      <li><code>/users</code> — list online users</li>
      <li><code>/msg &lt;user&gt; &lt;message&gt;</code> — private message</li>
      <li><code>/quit</code> — disconnect</li>
    </ul>
    <div class="small">Connected as: <span id="lblUser">—</span></div>
    <hr>
    <div><strong>Online</strong></div>
    <div id="users" class="users-list">—</div>
  </div>

  <div class="main">
    <div id="messages" class="messages"></div>

    <div class="inputbar">
      <input id="txtMsg" type="text" placeholder="Type a message or command (e.g. /users or /msg Alice hi)"/>
      <button id="btnSend">Send</button>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="login-modal">
    <div class="login">
      <h2>Join Chat</h2>
      <label>
        Name:
        <input id="inpName" type="text" placeholder="Your display name" style="width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ddd;">
      </label>
      <div style="height:8px"></div>
      <label>
        Password:
        <input id="inpPass" type="password" placeholder="Chatroom password" style="width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ddd;">
      </label>
      <div style="height:12px"></div>
      <button id="btnJoin" style="width:100%;">Join</button>
      <div id="loginError" class="small" style="color:#b00; display:none;"></div>
      <div class="small" style="margin-top:8px;">This is a simple password gate enforced by the WebSocket server.</div>
    </div>
  </div>

<script>
/*
  Client JS:
  - Edit WS_URL if server is elsewhere.
  - First message sent is an auth JSON: {type:"auth", username:"...", password:"..."}
  - After auth accepted, server will send messages as JSON: {type:"system"|"chat"|"private"|"users", ...}
*/

const WS_URL = "ws://127.0.0.1:8765"; // change if your server runs on a different host/port
let ws = null;
let username = null;

const loginModal = document.getElementById('loginModal');
const btnJoin = document.getElementById('btnJoin');
const inpName = document.getElementById('inpName');
const inpPass = document.getElementById('inpPass');
const loginError = document.getElementById('loginError');

const lblUser = document.getElementById('lblUser');
const usersDiv = document.getElementById('users');
const messages = document.getElementById('messages');
const txtMsg = document.getElementById('txtMsg');
const btnSend = document.getElementById('btnSend');

function appendMessage(html, kind="msg"){
  const d = document.createElement('div');
  d.className = 'msg ' + kind;
  d.innerHTML = html;
  messages.appendChild(d);
  messages.scrollTop = messages.scrollHeight;
}

function connectAndAuth(name, pass){
  ws = new WebSocket(WS_URL);

  ws.addEventListener('open', () => {
    // send auth JSON
    const auth = { type: "auth", username: name, password: pass };
    ws.send(JSON.stringify(auth));
  });

  ws.addEventListener('message', (ev) => {
    let packet;
    try { packet = JSON.parse(ev.data); } catch(e) {
      // legacy text: show raw
      appendMessage(`<span class="system">${ev.data}</span>`, 'system');
      return;
    }

    // handle server message types
    switch(packet.type){
      case 'auth_ok':
        loginModal.style.display = 'none';
        lblUser.textContent = name;
        appendMessage(`<span class="system">Connected. Welcome, ${name}.</span>`, 'system');
        break;
      case 'auth_fail':
        loginError.style.display = 'block';
        loginError.textContent = packet.reason || "Authentication failed";
        ws.close();
        break;
      case 'system':
        appendMessage(`<span class="system">${packet.message}</span>`, 'system');
        break;
      case 'chat':
        // chat: {type:'chat', from, text, timestamp}
        appendMessage(`<div class="meta">[${packet.timestamp}] <strong>${packet.from}</strong></div>${packet.text}`);
        break;
      case 'private':
        appendMessage(`<div class="meta">[${packet.timestamp}] <strong>${packet.from}</strong> <em>(private)</em></div><div class="private">${packet.text}</div>`);
        break;
      case 'users':
        // packet.users = [...]
        usersDiv.textContent = packet.users.join("\n");
        break;
      default:
        appendMessage(`<span class="system">Unknown packet: ${ev.data}</span>`, 'system');
    }
  });

  ws.addEventListener('close', () => {
    appendMessage('<span class="system">Disconnected from server.</span>', 'system');
    loginModal.style.display = 'block';
  });

  ws.addEventListener('error', (e) => {
    appendMessage('<span class="system">WebSocket error (check server).</span>', 'system');
  });
}

btnJoin.onclick = () => {
  const name = inpName.value.trim();
  const pass = inpPass.value;
  if(!name) { loginError.style.display='block'; loginError.textContent='Please enter a name'; return; }
  loginError.style.display='none';
  username = name;
  connectAndAuth(name, pass);
};

// send messages (raw or commands)
function sendMessage(text){
  if(!ws || ws.readyState !== WebSocket.OPEN) {
    appendMessage('<span class="system">Not connected.</span>', 'system');
    return;
  }
  // raw send as JSON: {type:"chat", text:...} -- server will parse commands
  ws.send(JSON.stringify({ type: "chat", text: text }));
}

btnSend.onclick = () => {
  const txt = txtMsg.value.trim();
  if(!txt) return;
  sendMessage(txt);
  txtMsg.value = "";
};

txtMsg.addEventListener('keydown', (e) => {
  if(e.key === 'Enter') { btnSend.click(); }
});
</script>
</body>
</html>
